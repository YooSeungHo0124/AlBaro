//IntelliJë¥¼ ì²˜ìŒì‚¬ìš©í•´ ë³´ê³  ìˆì–´ spring ê¸°ë³¸ ì •ë¦¬ì™€ í•¨ê»˜ intelliJì— ìµìˆ™í•´ì§€ê³  ìˆìŠµë‹ˆë‹¤.


// JPAì— ëŒ€í•´ ê¸°ì´ˆë¶€í„° ê³µë¶€í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì•„ë˜ëŠ” ì œê°€ ì •ë¦¬í•œ ë‚´ìš©ì…ë‹ˆë‹¤.

## JPA

- Java Persistence API
- ìë°” ì§„ì˜ì˜ ORM ê¸°ìˆ  í‘œì¤€

### ORM

- Object-relational mapping(ê°ì²´ ê´€ê³„ ë§¤í•‘)
    - ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§¤í•‘(ì—°ê²°)í•´ì¤€ë‹¤.
- ê°ì²´ëŠ” ê°ì²´ëŒ€ë¡œ ì„¤ê³„
- ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ëŠ” ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ëŒ€ë¡œ ì„¤ê³„
- ORM í”„ë ˆì„ì›Œí¬ê°€ ì¤‘ê°„ì—ì„œ ë§¤í•‘
- ëŒ€ì¤‘ì ì¸ ì–¸ì–´ì—ëŠ” ëŒ€ë¶€ë¶„ ORM ê¸°ìˆ ì´ ì¡´ì¬

### JPAëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ JDBC ì‚¬ì´ì—ì„œ ë™ì‘

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/18ad7ac4-b1c2-4b23-944e-a2b5d8b53fd5/c2459854-bac4-47cc-a6be-aaea08bd6a64/image.png)

- JDBC APIë¥¼ JPAê°€ ëŒ€ì‹ í•œë‹¤ê³  ìƒê°í•˜ë©´ ë¨

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/18ad7ac4-b1c2-4b23-944e-a2b5d8b53fd5/3272e0f9-79ca-45b4-9a1d-45b410ffbd07/image.png)

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/18ad7ac4-b1c2-4b23-944e-a2b5d8b53fd5/1936223b-d9af-4fa5-b62c-6e9a279db6d6/image.png)

## JPA ì–´í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œ

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/18ad7ac4-b1c2-4b23-944e-a2b5d8b53fd5/22b36500-fdd3-4a1b-bba1-817a2ec1a6fa/image.png)

- EntityManagerFactoryëŠ” í•„ìš”í•  ë•Œë§ˆë‹¤ EntityManagerë¥¼ ì°ì–´ ë‚´ëŠ” ê³µì¥ì´ì í´ë˜ìŠ¤

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/18ad7ac4-b1c2-4b23-944e-a2b5d8b53fd5/9b46fa57-6e0c-4a37-9758-bcdd2b9a41ed/image.png)

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/18ad7ac4-b1c2-4b23-944e-a2b5d8b53fd5/d3415e05-9c1f-4d17-94ce-7fd260e9921c/image.png)

- ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ëŠ” DBë‹¹ í•˜ë‚˜ë§Œ ìƒì„± ê°€ëŠ¥
- ì—”í‹°í‹° ë§¤ë‹ˆì €ëŠ” ê³ ê°ì˜ ìš”ì²­ì´ ì˜¬ ë•Œë§ˆë‹¤ ê³„ì† ì¼ë‹¤ê°€ ë²„ë ¸ë‹¤ê°€ í•˜ëŠ” ì‹ìœ¼ë¡œ ì‚¬ìš©
- ì—”í‹°í‹° ë§¤ë‹ˆì €: ì“°ë ˆë“œ ê°„ ê³µìœ  X, ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ ì²˜ëŸ¼ ë¹¨ë¦¬ ì“°ê³  ë¹¨ë¦¬ ë²„ë ¤ì•¼ í•¨

```JpaMain.java
package hellojpa;

import jakarta.persistence.*;

import java.util.List;

public class JpaMain {

    public static void main(String[] args) {

        EntityManagerFactory emf = Persistence.createEntityManagerFactory("hello");
        //persistence.xmlì— ë‚˜ì™€ìˆëŠ” name ë„£ì–´ì£¼ê¸°
        //Factory ë§Œë“œëŠ” ìˆœê°„ DBì—°ê²°ë„ ë˜ê³  ì›¬ë§Œí•œ ê±´ ë‹¤ ë¨

        //ì¼ê´€ì ì¸ í•œ ë‹¨ìœ„ë¥¼ í•  ë•Œ ë§ˆë‹¤ managerë¥¼ ë§Œë“¤ì–´ì¤˜ì•¼ í•¨.
        EntityManager em = emf.createEntityManager();

        //code

        //JPAì—ì„œëŠ” íŠ¸ëœì­ì…˜ì˜ ë‹¨ìœ„ê°€ ì¤‘ìš”. ëª¨ë“  ë°ì´í„°ë¥¼ ë³€ê²½í•˜ëŠ” ê³¼ì •ì€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ í–‰í•´ì ¸ì•¼ í•œë‹¤!
        EntityTransaction tx = em.getTransaction();
        tx.begin();

        try{

            Member member = new Member(200L,"member200");
            em.persist(member);
            em.flush();

            System.out.println("==============");
            tx.commit();

//            //1. ì €ì¥
//
//            //ë¹„ì˜ì†
//            Member member = new Member();
//            member.setId(101L);
//            member.setName("HelloJPA");
//
//            //ì˜ì†
//            System.out.println("========BEFORE=======");
//            em.persist(member); //ë°ì´í„°ì— ì €ì¥
//            System.out.println("========AFTER=======");
//
//            Member findMember = em.find(Member.class, 101L);
//
//            System.out.println("findMember.id = "+ findMember.getId());
//            System.out.println("findMember.name = "+ findMember.getName());


//            //2. ì¡°íšŒ
//            Member findMember = em.find(Member.class, 3L);
//            //ì²«ë²ˆì§¸ íŒŒë¼ë¯¸í„°ëŠ” ì—”í‹°í‹° í´ë˜ìŠ¤ ì ì–´ì•¼ í•¨. ì°¾ì•„ì£¼ëŠ” ë©”ì„œë“œ
//            System.out.println("findMember.id = "+ findMember.getId());
//            System.out.println("findMember.name = "+ findMember.getName());

            //3. ì‚­ì œ
//            em.remove(findMember);

//            //4. ìˆ˜ì •
//            Member findMember = em.find(Member.class, 3L);
//            //ì²«ë²ˆì§¸ íŒŒë¼ë¯¸í„°ëŠ” ì—”í‹°í‹° í´ë˜ìŠ¤ ì ì–´ì•¼ í•¨. ì°¾ì•„ì£¼ëŠ” ë©”ì„œë“œ
//            findMember.setName("HelloJPA");
//            //JPAê°€ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ ì»¤ë°‹ì„ í•˜ê¸° ì „ì— ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²ƒì„ ì•Œì•„ì„œ íŒŒì•…í•˜ê³ 
//            //update ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•¨

            //JPQL
//            List <Member> result = em.createQuery("select m from Member as m", Member.class)
//                    .setFirstResult(1)
//                    .setMaxResults(8) //1ë²ˆë¶€í„° 8ê°œ ê°€ì ¸ì™€! ë¼ëŠ” ëœ»
//                    .getResultList();
//            //Member ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ í•˜ëŠ” ê²ƒì„. ëŒ€ìƒì´ í…Œì´ë¸”ì´ ì•„ë‹ˆê³  ê°ì²´ì„
//
//            for(Member member: result){
//            System.out.println("member.name = "+ member.getName());
//            }

            tx.commit();
        }catch (Exception e){
            tx.rollback();
        }finally {
            em.close();
        }
        emf.close();
    }
}
```
```Member.java
package hellojpa;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import jakarta.persistence.Table;

@Entity
//@Table(name = "USER")
// <- (ë§¤í•‘ í•  ë•Œ) dbì— ì €ì¥ëœ í…Œì´ë¸”ê³¼ class ì´ë¦„ì´ ë‹¤ë¥¼ ë•Œ ì–´ë–¤ í…Œì´ë¸”ì¸ì§€ ì§€ì •, ì—†ìœ¼ë©´ ê¸°ë³¸ìœ¼ë¡œ í´ë˜ìŠ¤ ì´ë¦„

public class Member {

    // ê¸°ë³¸ í‚¤ì—ëŠ” Id annotation ë¶™ì´ê¸°
    @Id
    private Long id;
//   @Column(name = "username") <- ì•„ê¹Œì™€ ë§ˆì°¬ê°€ì§€~
    private String name;

    Member(){

    }

    public Member(Long id, String name) {
        this.id = id;
        this.name = name;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
```
```persistence.xml
<?xml version="1.0" encoding="UTF-8"?>
<persistence version="2.2" xmlns="http://xmlns.jcp.org/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd">
    <persistence-unit name="hello">
        <properties>
            <!-- í•„ìˆ˜ ì†ì„± -->
            <property name="jakarta.persistence.jdbc.driver" value="org.h2.Driver"/>
            <property name="jakarta.persistence.jdbc.user" value="sa"/>
            <property name="jakarta.persistence.jdbc.password" value=""/>
            <property name="jakarta.persistence.jdbc.url" value="jdbc:h2:tcp://localhost/~/test"/>
            <property name="hibernate.dialect" value="org.hibernate.dialect.H2Dialect"/>
		<!--ì´ ì˜µì…˜ì„ ë„£ì–´ì¤˜ì•¼ íŠ¹ì •ë² ì´ìŠ¤ ë§Œì˜ ê³ ìœ í•œ ëª…ë ¹ì–´ë“¤ì„ ê°ì•ˆí•´ì„œ jpaê°€ ê³ ë ¤í•´ì¤Œ-->
		<!--ì“°ëŠ” ë“œë¼ì´ë²„ì— ë”°ë¼ ì†ì„± ë‹¤ë¥´ê²Œ ì„¤ì •í•´ì£¼ë©´ ëœë‹¤. ê°™ì€ ìœ„ì¹˜ì—!-->

            <!-- ì˜µì…˜ -->
            <property name="hibernate.show_sql" value="true"/>
            <property name="hibernate.format_sql" value="true"/>
            <property name="hibernate.use_sql_comments"  value="true"/>
<!--            <property name="hibernate.hbm2ddl.auto" value="create" />-->
        </properties>
    </persistence-unit>

</persistence>
```


## JPQL

- JPAë¥¼ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹° ê°ì²´ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ê°œë°œ
- ë¬¸ì œëŠ” ê²€ìƒ‰ ì¿¼ë¦¬
- ê²€ìƒ‰ì„ í•  ë•Œë„ í…Œì´ë¸”ì´ ì•„ë‹Œ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ê²€ìƒ‰
- ëª¨ë“  DB ë°ì´í„°ë¥¼ ê°ì²´ë¡œ ë³€í™˜í•´ì„œ ê²€ìƒ‰í•˜ëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥
- ì• í”Œë¦¬ì¼€ì´ì…˜ì´ í•„ìš”í•œ ë°ì´í„°ë§Œ DBì—ì„œ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ê²°êµ­ ê²€ìƒ‰ ì¡°ê±´ì´ í¬í•¨ëœ SQLì´ í•„ìš”
- JPAëŠ” SQLì„ ì¶”ìƒí™”í•œ JPQLì´ë¼ëŠ” ê°ì²´ ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´ ì œê³µ-
- SQLê³¼ ë¬¸ë²• ìœ ì‚¬, SELECT, FROM, WHERE, GROUP BY,
HAVING, JOIN ì§€ì›
- JPQLì€ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬
- SQLì€ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì„ ëŒ€ìƒìœ¼ë¡œ ì¿¼ë¦¬

```java
/ê²€ìƒ‰ 
String jpql = "select m From Member m where m.name like â€˜%hello%'"; 
List<Member> result = em.createQuery(jpql, Member.class) 
          .getResultList(); 
          //ê²°ê³¼ ê°€ì ¸ì™€
```

- í…Œì´ë¸”ì´ ì•„ë‹Œ ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ ê²€ìƒ‰í•˜ëŠ” ê°ì²´ ì§€í–¥ ì¿¼ë¦¬
- SQLì„ ì¶”ìƒí™”í•´ì„œ íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ SQLì— ì˜ì¡´X
- JPQLì„ í•œë§ˆë””ë¡œ ì •ì˜í•˜ë©´ ê°ì²´ ì§€í–¥ SQL

```java
 //ê²€ìƒ‰ 
  String jpql = "select m from Member m where m.age > 18"; 
 
  List<Member> result = em.createQuery(jpql, Member.class) 
          .getResultList();
```

```java
 // ì‹¤í–‰ëœ SQL 
        select 
            m.id as id, 
            m.age as age, 
            m.USERNAME as USERNAME, 
            m.TEAM_ID as TEAM_ID 
        from 
            Member m 
        where 
            m.age>18 
```

### Criteria

<aside>
ğŸ’¡

//Criteria ì‚¬ìš© ì¤€ë¹„
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Member> query = cb.createQuery(Member.class);

//ë£¨íŠ¸ í´ë˜ìŠ¤ (ì¡°íšŒë¥¼ ì‹œì‘í•  í´ë˜ìŠ¤)
Root<Member> m = query.from(Member.class);

//ì¿¼ë¦¬ ìƒì„± CriteriaQuery<Member> cq =

query.select(m).where(cb.equal(m.get("username"), â€œkimâ€));
List<Member> resultList = em.createQuery(cq).getResultList();

</aside>

- ë¬¸ìê°€ ì•„ë‹Œ ìë°”ì½”ë“œë¡œ JPQLì„ ì‘ì„±í•  ìˆ˜ ìˆìŒ
- JPQL ë¹Œë” ì—­í• 
- JPA ê³µì‹ ê¸°ëŠ¥
- ë‹¨ì : ë„ˆë¬´ ë³µì¡í•˜ê³  ì‹¤ìš©ì„±ì´ ì—†ë‹¤.
- Criteria ëŒ€ì‹ ì— QueryDSL ì‚¬ìš© ê¶Œì¥

### QueryDSL

```java
//select m from Member m where m.age >18;

JPAFactoryQuery query = new JPAQueryFactory(em); 
  QMember m = QMember.member; 
 
  List<Member> list =  
      query.selectFrom(m) 
           .where(m.age.gt(18)) 
           .orderBy(m.name.desc()) 
           .fetch(); 
   
  
```

- ë¬¸ìê°€ ì•„ë‹Œ ìë°”ì½”ë“œë¡œ JPQLì„ ì‘ì„±í•  ìˆ˜ ìˆìŒ
- JPQL ë¹Œë” ì—­í• 
- ì»´íŒŒì¼ ì‹œì ì— ë¬¸ë²• ì˜¤ë¥˜ ì°¾ê¸° ê°€ëŠ¥
- ë™ì ì¿¼ë¦¬ ì‘ì„± í¸ë¦¬í•¨
- ë‹¨ìˆœí•˜ê³  ì‰¬ì›€

### ë„¤ì´í‹°ë¸Œ SQL

- JPAê°€ ì œê³µí•˜ëŠ” SQLì„ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥
- JPQLë¡œ í•´ê²°í•  ìˆ˜ ì—†ëŠ” íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ì— ì˜ì¡´ì ì¸ ê¸°ëŠ¥
- ì˜ˆ) ì˜¤ë¼í´ CONNECT BY, íŠ¹ì • DBë§Œ ì‚¬ìš©í•˜ëŠ” SQL íŒíŠ¸

```java
String sql =  
    â€œSELECT ID, AGE, TEAM_ID, NAME FROM MEMBER WHERE NAME = â€˜kimâ€™";  
List<Member> resultList =  
            em.createNativeQuery(sql, Member.class).getResultList(); 
```

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/18ad7ac4-b1c2-4b23-944e-a2b5d8b53fd5/7f943240-df37-4b02-b781-9c0578f8081f/image.png)

### JPQL ë¬¸ë²•

<aside>
ğŸ’¡

select_ë¬¸ :: =

select_ì ˆ
from_ì ˆ
[where_ì ˆ]
[groupby_ì ˆ]
[having_ì ˆ]
[orderby_ì ˆ]
update_ë¬¸ :: = update_ì ˆ [where_ì ˆ]
delete_ë¬¸ :: = delete_ì ˆ [where_ì ˆ]

</aside>

- select m from Member as m where m.age > 18
- ì—”í‹°í‹°ì™€ ì†ì„±ì€ ëŒ€ì†Œë¬¸ì êµ¬ë¶„O (Member, age)
- JPQL í‚¤ì›Œë“œëŠ” ëŒ€ì†Œë¬¸ì êµ¬ë¶„X (SELECT, FROM, where)
- ì—”í‹°í‹° ì´ë¦„ ì‚¬ìš©, í…Œì´ë¸” ì´ë¦„ì´ ì•„ë‹˜(Member)
- ë³„ì¹­ì€ í•„ìˆ˜(m) (asëŠ” ìƒëµê°€ëŠ¥)

### ì§‘í•©ê³¼ ì •ë ¬

<aside>
ğŸ’¡

select
COUNT(m),   //íšŒì›ìˆ˜
SUM(m.age), //ë‚˜ì´ í•©
AVG(m.age), //í‰ê·  ë‚˜ì´
MAX(m.age), //ìµœëŒ€ ë‚˜ì´
MIN(m.age)  //ìµœì†Œ ë‚˜ì´
from Member m

</aside>

### TypeQuery, Query

- TypeQuery: ë°˜í™˜ íƒ€ì…ì´ ëª…í™•í•  ë•Œ ì‚¬ìš©
- Query: ë°˜í™˜ íƒ€ì…ì´ ëª…í™•í•˜ì§€ ì•Šì„ ë•Œ ì‚¬ìš©


